# دليل نظام النماذج الديناميكية - التكامل مع لوحة الأدمن

## نظرة عامة

يشرح هذا الدليل كيفية تحسين نظام النماذج الديناميكية للتأكد من وصول جميع بيانات النماذج إلى لوحة تحكم الأدمن بالتفاصيل الكاملة.

## ما تم تنفيذه

### 1. هيكل قاعدة البيانات (موجود بالفعل)

يستخدم النظام جدولين رئيسيين:
- `form_questions`: يخزن جميع أسئلة النماذج بشكل ديناميكي
- `form_responses`: يخزن إجابات المستخدمين المرتبطة بالطلبات

### 2. ملف بيانات البداية

**الملف**: `seed_form_questions.sql`

يحتوي هذا الملف على جميع الأسئلة المحددة مسبقًا لـ:
- **نموذج التطوع** (12 سؤالاً إجمالاً):
  - 7 حقول أساسية (الاسم، البريد الإلكتروني، الهاتف، العنوان، تاريخ الميلاد، جهات اتصال الطوارئ)
  - 5 حقول إضافية (الاهتمامات، المهارات، التوفر، الخبرة، الدافع)

- **نموذج الشراكات** (9 أسئلة إجمالاً):
  - 5 حقول أساسية (اسم المنظمة، الشخص المسؤول، البريد الإلكتروني، الهاتف، الرسالة)
  - 4 حقول إضافية (نوع المنظمة، نوع الشراكة، الموقع الإلكتروني، كيف سمعت عنا)

**كيفية الاستخدام**:
1. انتقل إلى لوحة تحكم Supabase الخاصة بك
2. اذهب إلى محرر SQL (SQL Editor)
3. انسخ والصق المحتوى الكامل لملف `seed_form_questions.sql`
4. اضغط على "Run" لإدراج الأسئلة في قاعدة البيانات

### 3. مكون جديد: FormResponsesViewer

**الموقع**: `src/components/admin/FormResponsesViewer.tsx`

هذا المكون القابل لإعادة الاستخدام:
- يجلب جميع إجابات النماذج لطلب معين
- يعرض الإجابات مجموعة حسب الأقسام (المعلومات الأساسية / التفاصيل الإضافية)
- يتعامل مع أنواع مختلفة من الأسئلة (نص، ملفات، تواريخ، إلخ)
- يعرض روابط تحميل الملفات عند الاقتضاء
- يدعم العرض ثنائي اللغة (الإنجليزية/العربية)

### 4. صفحات الأدمن المحدثة

#### VolunteersManagement.tsx (إدارة المتطوعين)
- تمت إضافة مكون `FormResponsesViewer` إلى نافذة التفاصيل
- يعرض الآن جميع إجابات النموذج الديناميكي أسفل المعلومات الأساسية
- يمكن للأدمن رؤية كل إجابة قدمها المتطوعون

#### PartnershipsManagement.tsx (إدارة الشراكات)
- تمت إضافة مكون `FormResponsesViewer` إلى نافذة التفاصيل
- يعرض الآن جميع إجابات النموذج الديناميكي أسفل المعلومات الأساسية
- يمكن للأدمن رؤية كل إجابة قدمتها المنظمات

## كيف يعمل النظام

### رحلة المستخدم
1. يزور المستخدم صفحة التطوع أو الشراكات
2. يضغط على زر "ابدأ الطلب"
3. يملأ النموذج الديناميكي (سؤال واحد في كل مرة)
4. يرسل النموذج
5. يتم حفظ البيانات في:
   - الجدول الرئيسي (`volunteer_applications` أو `partnership_inquiries`) للمعلومات الأساسية
   - جدول `form_responses` لجميع إجابات الأسئلة

### رحلة الأدمن
1. يسجل الأدمن الدخول إلى لوحة التحكم
2. ينتقل إلى صفحة "Volunteers" أو "Partnerships"
3. يرى قائمة بجميع الطلبات
4. يضغط على "View" (أيقونة العين) على أي طلب
5. تفتح نافذة تعرض:
   - المعلومات الأساسية في الأعلى
   - **قسم "Additional Form Responses"** أدناه
   - جميع الأسئلة والإجابات منظمة حسب القسم
   - روابط تحميل الملفات إذا تم رفع ملفات

## المميزات الرئيسية

### إدارة الأسئلة الديناميكية
- يتم تخزين الأسئلة في قاعدة البيانات، وليست مكتوبة في الكود
- يمكن إضافتها/تعديلها من خلال لوحة الأدمن (صفحة FormQuestionsManagement)
- التغييرات تأخذ مفعولها فورًا بدون تحديثات برمجية

### التقاط شامل للبيانات
- كل حقل من النموذج يصل إلى الأدمن
- لا تضيع أي بيانات أو تُخفى
- الملفات المرفوعة مخزنة ومتاحة للوصول

### عرض سهل الاستخدام
- الإجابات مجموعة حسب أقسام منطقية
- تسميات واضحة بالإنجليزية والعربية
- تصميم نظيف ومنظم
- تنسيق سهل القراءة

### الأمان
- تفعيل RLS (Row Level Security) على جميع الجداول
- الوصول للأدمن فقط لعرض جميع الإجابات
- المستخدمون يمكنهم فقط رؤية إجاباتهم الخاصة

## خطوات التحقق

بعد تشغيل ملف SQL، تحقق من الإعداد:

1. **تحقق من الأسئلة**:
   ```sql
   SELECT form_type, question_text_en, question_text_ar, order_index
   FROM form_questions
   WHERE form_type IN ('volunteer', 'partnership')
   ORDER BY form_type, order_index;
   ```

2. **اختبر نموذج التطوع**:
   - زر `/get-involved/volunteer`
   - اضغط على "Start Application"
   - املأ وأرسل النموذج
   - اذهب إلى لوحة الأدمن → Volunteers
   - اعرض الطلب وتحقق من ظهور جميع الإجابات

3. **اختبر نموذج الشراكات**:
   - زر `/get-involved/partnerships`
   - اضغط على "Start Partnership Application"
   - املأ وأرسل النموذج
   - اذهب إلى لوحة الأدمن → Partnerships
   - اعرض الطلب وتحقق من ظهور جميع الإجابات

## حل المشاكل

### لا تظهر الأسئلة في النموذج
- **المشكلة**: نافذة النموذج تعرض "No questions available"
- **الحل**: قم بتشغيل ملف `seed_form_questions.sql` في محرر SQL في Supabase

### الإجابات لا تظهر في لوحة الأدمن
- **المشكلة**: تظهر المعلومات الأساسية فقط، لا يوجد قسم "Additional Form Responses"
- **الحل**:
  1. تحقق من أن جدول form_responses يحتوي على بيانات لهذا application_id
  2. تحقق من أن سياسات RLS تسمح للأدمن بقراءة form_responses
  3. افحص console المتصفح لأي أخطاء

### روابط الملفات لا تعمل
- **المشكلة**: روابط الملفات لا تفتح
- **الحل**:
  1. تحقق من وجود bucket التخزين 'wakala-documents' ولديه صلاحية قراءة عامة
  2. تحقق من أن روابط الملفات في جدول form_responses صحيحة

## التحسينات المستقبلية

تحسينات ممكنة:
1. إضافة بحث/فلترة للأسئلة في الأدمن
2. تصدير الإجابات إلى CSV مع أعمدة ديناميكية
3. إضافة تحليلات للأسئلة (الإجابات الأكثر شيوعًا، إلخ)
4. دعم الأسئلة المشروطة (إظهار س2 إذا كانت س1 = "نعم")
5. معاينة الملفات في لوحة الأدمن
6. عمليات جماعية على الإجابات

## التفاصيل التقنية

### خصائص المكون

**FormResponsesViewer**:
```typescript
interface FormResponsesViewerProps {
  applicationId: string;      // معرف الطلب/الاستفسار
  formType: 'volunteer' | 'partnership' | 'job_application';
  language?: 'en' | 'ar';     // لغة العرض (الافتراضي: 'en')
}
```

### العلاقات في قاعدة البيانات

```
form_questions (id) ← form_responses (question_id)
volunteer_applications (id) ← form_responses (application_id)
partnership_inquiries (id) ← form_responses (application_id)
```

## الدعم

إذا واجهت أي مشاكل أو احتجت إلى المساعدة:
1. افحص console المتصفح لرسائل الأخطاء
2. تحقق من جداول Supabase وسياسات RLS
3. تأكد من تحميل بيانات البداية بشكل صحيح
4. راجع هذا الدليل للحلول الشائعة

---

**آخر تحديث**: فبراير 2026
**الإصدار**: 1.0
